{% extends "dashboard.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid my-4">

    <!-- Page Header -->
    <div class="row align-items-center mb-4 g-3">
        <div class="col-12 col-lg-4 text-center text-lg-start">
            <h3 class="mb-0">Combined Yearly Payroll Detail</h3>
        </div>

        <!-- Export Button -->
        <div class="col-12 col-lg-4 text-center text-lg-end">
            <a href="{% url 'export_combined_yearly_detail_to_excel' %}" class="btn btn-success w-100 w-lg-auto">
                <i class="bi bi-file-earmark-excel-fill me-1"></i> Export to Excel
            </a>
        </div>
    </div>

    {% if page_obj %}
    {% for year in page_obj %}
    <!-- Payroll Card -->
    <div class="card shadow-sm mb-5 border-primary mx-auto" style="max-width: 1160px;"
         id="combined_yearly_detail_{{ forloop.counter }}">
        <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
            Combined Yearly Payroll Detail for {{ year.year }}

            <!-- Collapse toggle button -->
            <button class="btn btn-sm btn-light" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse_{{ forloop.counter }}"
                    aria-expanded="true"
                    aria-controls="collapse_{{ forloop.counter }}">
                <i class="bi bi-caret-down-fill"></i>
            </button>
        </div>

        <div id="collapse_{{ forloop.counter }}" class="collapse show">
            <div class="card-body px-4">
                <div class="row g-4">
                    <!-- LEFT COLUMN (Main Content) -->
                    <div class="col-md-8 pe-md-4">
                        <!-- REGULAR PAYROLL SECTION -->
                        <div class="mb-4">
                            <h5 class="text-success border-bottom pb-2 mb-3">Regular Payroll</h5>

                            <!-- Regular Components -->
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, amount in year.regular_item_by_component.items %}
                                        {% if amount %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ amount|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Regular Summary -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ year.regular.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Non-Taxable Gross</td>
                                            <td class="text-end">{{ year.regular.non_taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Gross Pay</strong></td>
                                            <td class="text-end"><strong>{{ year.regular.gross|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Pensionable Amount</td>
                                            <td class="text-end">{{ year.regular.pensionable|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employee Pension</td>
                                            <td class="text-end">{{ year.regular.employee_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employer Pension</td>
                                            <td class="text-end">{{ year.regular.employer_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Pension</td>
                                            <td class="text-end">{{ year.regular.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ year.regular.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Regular Deduction</td>
                                            <td class="text-end">{{ year.regular.total_regular_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-success">
                                            <td><strong>Net Pay</strong></td>
                                            <td class="text-end"><strong>{{ year.regular.net_pay|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ year.regular.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- EARNING ADJUSTMENTS SECTION -->
                        {% if year.show_earning %}
                        <div class="mb-4">
                            <h5 class="text-warning border-bottom pb-2 mb-3">Earning Adjustments</h5>

                            <!-- Earning Components -->
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Earning Amount</th>
                                            <th class="text-end">Taxable</th>
                                            <th class="text-end">Non-Taxable</th>
                                            <th class="text-end">Employee Pension</th>
                                            <th class="text-end">Employer Pension</th>
                                            <th class="text-end">Total Pension</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, vals in year.earning_adj_by_component.items %}
                                        {% if vals.earning_amount %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ vals.earning_amount|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.taxable|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.non_taxable|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.employee_pension_contribution|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.employer_pension_contribution|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Earning Summary -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ year.adjustment.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Non-Taxable Gross</td>
                                            <td class="text-end">{{ year.adjustment.non_taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Gross Adjustment</strong></td>
                                            <td class="text-end"><strong>{{ year.adjustment.gross|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Adjusted Pensionable</td>
                                            <td class="text-end">{{ year.adjustment.adjusted_pensionable|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employee Pension</td>
                                            <td class="text-end">{{ year.adjustment.employee_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employer Pension</td>
                                            <td class="text-end">{{ year.adjustment.employer_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Pension</td>
                                            <td class="text-end">{{ year.adjustment.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ year.adjustment.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Earning Adjustment Deduction</td>
                                            <td class="text-end">{{ year.adjustment.earning_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ year.adjustment.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- DEDUCTION ADJUSTMENTS SECTION -->
                        {% if year.show_deduction %}
                        <div class="mb-4">
                            <h5 class="text-danger border-bottom pb-2 mb-3">Deduction Adjustments</h5>

                            <!-- Deduction Components -->
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, amount in year.deduction_adj_by_component.items %}
                                        {% if amount %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ amount|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Deduction Summary -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Individual Adjustment Deduction</td>
                                            <td class="text-end">{{ year.adjustment.individual_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- ADJUSTMENT SUMMARY (Combined Earning & Deduction) -->
                        <div class="mb-4">
                            <h5 class="text-info border-bottom pb-2 mb-3">Adjustment Summary</h5>

                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-info">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ year.adjustment.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Non-Taxable Gross</td>
                                            <td class="text-end">{{ year.adjustment.non_taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Gross Adjustment</strong></td>
                                            <td class="text-end"><strong>{{ year.adjustment.gross|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Adjusted Pensionable</td>
                                            <td class="text-end">{{ year.adjustment.adjusted_pensionable|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employee Pension</td>
                                            <td class="text-end">{{ year.adjustment.employee_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employer Pension</td>
                                            <td class="text-end">{{ year.adjustment.employer_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Pension</td>
                                            <td class="text-end">{{ year.adjustment.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ year.adjustment.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Earning Adjustment Deduction</td>
                                            <td class="text-end">{{ year.adjustment.earning_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Individual Adjustment Deduction</td>
                                            <td class="text-end">{{ year.adjustment.individual_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Total Yearly Adjustment Deduction</strong></td>
                                            <td class="text-end"><strong>{{ year.adjustment.total_yearly_adjustment_deduction|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td><strong>Net Yearly Adjustment</strong></td>
                                            <td class="text-end"><strong>{{ year.adjustment.net_yearly_adjustment|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ year.adjustment.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- SEVERANCE PAY SECTION -->
                        {% if year.severance.gross %}
                        <div class="mb-4">
                            <h5 class="text-purple border-bottom pb-2 mb-3">Severance Pay</h5>

                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-purple">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ year.severance.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>Gross Pay</strong></td>
                                            <td class="text-end"><strong>{{ year.severance.gross|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ year.severance.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Severance Deduction</td>
                                            <td class="text-end">{{ year.severance.total_severance_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-success">
                                            <td><strong>Net Pay</strong></td>
                                            <td class="text-end"><strong>{{ year.severance.net|floatformat:2|intcomma }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ year.severance.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- RIGHT COLUMN (Total Summary) -->
                    <div class="col-md-4">
                        <div class="sticky-top" style="top: 20px;">
                            <h5 class="text-primary border-bottom pb-2 mb-3">Total Summary</h5>

                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-info">
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ year.totals.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-info">
                                            <td>Non-Taxable Gross</td>
                                            <td class="text-end">{{ year.totals.non_taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-info">
                                            <td>Total Gross</td>
                                            <td class="text-end">{{ year.totals.gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>Pensionable</td>
                                            <td class="text-end">{{ year.totals.pensionable|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>Employee Pension</td>
                                            <td class="text-end">{{ year.totals.employee_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>Employer Pension</td>
                                            <td class="text-end">{{ year.totals.employer_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>Total Pension</td>
                                            <td class="text-end">{{ year.totals.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ year.totals.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Deduction</td>
                                            <td class="text-end">{{ year.totals.total_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr class="table-success fw-bold">
                                            <td>Final Net Pay</td>
                                            <td class="text-end">{{ year.totals.final_net_pay|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ year.totals.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Button -->
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-success"
                            onclick="printCombinedDetail('combined_yearly_detail_{{ forloop.counter }}')">
                        Save or Print Payslip
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center text-danger">No payroll data found.</p>
    {% endif %}

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
        {% include "pagination.html" %}
    </div>
</div>

<style>
    .table-purple {
        background-color: #7030A0;
        color: white;
    }
    .text-purple {
        color: #7030A0;
    }
</style>

{% endblock %}

