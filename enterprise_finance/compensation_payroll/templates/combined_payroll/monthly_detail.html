{% extends "dashboard.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid my-4">

    <!-- Page Header -->
    <div class="row align-items-center mb-4 g-3">
        <div class="col-12 col-lg-4 text-center text-lg-start">
            <h3 class="mb-0">Combined Monthly Payroll Detail</h3>
        </div>

        <!-- Export Button -->
        <div class="col-12 col-lg-4 text-center text-lg-end">
            <a href="{% url 'export_combined_monthly_detail_to_excel' %}" class="btn btn-success w-100 w-lg-auto">
                <i class="bi bi-file-earmark-excel-fill me-1"></i> Export to Excel
            </a>
        </div>
    </div>

    {% if page_obj %}
    {% for month in page_obj %}
    <!-- Payroll Card -->
    <div class="card shadow-sm mb-5 border-primary mx-auto" style="max-width: 1160px;"
         id="combined_monthly_detail_{{ forloop.counter }}">
        <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
            Combined Monthly Payroll Detail for {{ month.month }}

            <!-- Collapse toggle button -->
            <button class="btn btn-sm btn-light" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse_{{ forloop.counter }}"
                    aria-expanded="true"
                    aria-controls="collapse_{{ forloop.counter }}">
                <i class="bi bi-caret-down-fill"></i>
            </button>
        </div>

        <div id="collapse_{{ forloop.counter }}" class="collapse show">
            <div class="card-body px-4">
                <div class="row g-4">
                    <!-- LEFT COLUMN -->
                    <div class="col-md-8 pe-md-4 border-end">

                        <!-- Regular Payroll Details -->
                        {% if month.regular_item_by_component %}
                        <div>
                            <h5 class="text-primary border-bottom pb-1">Regular Payroll Details</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key, val in month.regular_item_by_component.items %}
                                        {% if val %}
                                        <tr>
                                            <td>{{ key }}</td>
                                            <td class="text-end">{{ val|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                        <tr>
                                            <td>Employee Pension</td>
                                            <td class="text-end">{{ month.regular.employee_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employer Pension</td>
                                            <td class="text-end">{{ month.regular.employer_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ month.regular.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Regular Deduction</td>
                                            <td class="text-end">{{ month.regular.total_regular_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Net Pay</td>
                                            <td class="text-end">{{ month.regular.net_pay|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ month.regular.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Earning Adjustments -->
                        {% if month.show_earning %}
                        <div class="mt-4">
                            <h5 class="text-success border-bottom pb-1">Earning Adjustments</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Earning Amount</th>
                                            <th class="text-end">Taxable</th>
                                            <th class="text-end">Non-Taxable</th>
                                            <th class="text-end">Employee Pension</th>
                                            <th class="text-end">Employer Pension</th>
                                            <th class="text-end">Total Pension</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, vals in month.earning_adj_by_component.items %}
                                        {% if vals.earning_amount %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ vals.earning_amount|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.taxable|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.non_taxable|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.employee_pension_contribution|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.employer_pension_contribution|floatformat:2|intcomma }}</td>
                                            <td class="text-end">{{ vals.total_pension|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Deduction Adjustments -->
                        {% if month.show_deduction %}
                        <div class="mt-4">
                            <h5 class="text-danger border-bottom pb-1">Deduction Adjustments</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Deduction Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, val in month.deduction_adj_by_component.items %}
                                        {% if val %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ val|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                        <tr>
                                            <td>Total Individual Deduction</td>
                                            <td class="text-end">{{ month.adjustment.individual_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
<!--                        total adjustment-->
                        <div class="m-3">
                            <h5>Total Adjustment</h5>
                            <!-- Full Adjustment Summary -->
                            <div class="table-responsive mt-2">
                                <table class="table table-bordered table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Recorded Employment Income Tax:</td>
                                            <td class="text-end">{{ month.adjustment.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>

                                        <tr>
                                            <td>Earning Adjustment Deduction:</td>
                                            <td class="text-end">{{ month.adjustment.earning_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Net Monthly Adjustment:</td>
                                            <td class="text-end">{{ month.adjustment.net_monthly_adjustment|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Adjustment Deduction:</td>
                                            <td class="text-end">{{ month.adjustment.total_monthly_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Expense:</td>
                                            <td class="text-end">{{ month.adjustment.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
<!---->
                        <!-- Severance Pay -->
                        {% with s=month.severance %}
                        {% if s.taxable_gross or s.gross or s.employment_income_tax or s.total_severance_deduction or s.net or s.expense %}
                        <div class="mt-4">
                            <h5 class="text-info border-bottom pb-1">Severance Pay</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Taxable Gross</td>
                                            <td class="text-end">{{ s.taxable_gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Gross</td>
                                            <td class="text-end">{{ s.gross|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Employment Income Tax</td>
                                            <td class="text-end">{{ s.employment_income_tax|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Severance Deduction</td>
                                            <td class="text-end">{{ s.total_severance_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Net Severance</td>
                                            <td class="text-end">{{ s.net|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <td>Expense</td>
                                            <td class="text-end">{{ s.expense|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>

                    <!-- RIGHT COLUMN: Total Summary -->
                    <div class="col-md-4">
                        <h5 class="text-dark border-bottom pb-1">Total Summary</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Component</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="table-info">
                                        <td>Taxable Gross</td>
                                        <td class="text-end">{{ month.totals.taxable_gross|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td>Non-Taxable Gross</td>
                                        <td class="text-end">{{ month.totals.non_taxable_gross|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td>Total Gross</td>
                                        <td class="text-end">{{ month.totals.gross|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td>Pensionable</td>
                                        <td class="text-end">{{ month.totals.pensionable|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td>Employee Pension</td>
                                        <td class="text-end">{{ month.totals.employee_pension|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td>Employer Pension</td>
                                        <td class="text-end">{{ month.totals.employer_pension|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td>Total Pension</td>
                                        <td class="text-end">{{ month.totals.total_pension|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td>Employment Income Tax</td>
                                        <td class="text-end">{{ month.totals.employment_income_tax|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td>Total Deduction</td>
                                        <td class="text-end">{{ month.totals.total_deduction|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr class="table-success fw-bold">
                                        <td>Final Net Pay</td>
                                        <td class="text-end">{{ month.totals.final_net_pay|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td>Expense</td>
                                        <td class="text-end">{{ month.totals.expense|floatformat:2|intcomma }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Print Button -->
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-success"
                            onclick="printCombinedDetail('combined_monthly_detail_{{ forloop.counter }}')">
                        Save or Print Payslip
                    </button>
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center text-danger">No payroll data found.</p>
    {% endif %}

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
        {% include "pagination.html" %}
    </div>
</div>
{% endblock %}
